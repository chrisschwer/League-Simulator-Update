schemaVersion: 2.0.0

metadataTest:
  user: "1000:1000"
  env:
    - key: 'TZ'
      value: 'Europe/Berlin'
  volumes: ['/RCode/league_results', '/ShinyApp/data']

fileExistenceTests:
  - name: "Application directory exists"
    path: "/RCode"
    shouldExist: true
    isDir: true

  - name: "Shiny app directory exists"
    path: "/ShinyApp"
    shouldExist: true
    isDir: true

  - name: "Shiny app.R exists"
    path: "/ShinyApp/app.R"
    shouldExist: true
    permissions: "-rw-r--r--"

  - name: "Shiny data directory exists"
    path: "/ShinyApp/data"
    shouldExist: true
    isDir: true

  - name: "Shiny update script exists"
    path: "/RCode/updateShiny.R"
    shouldExist: true
    permissions: "-rw-r--r--"

  - name: "Shiny scheduler script exists"
    path: "/RCode/shiny_scheduler.R"
    shouldExist: true
    permissions: "-rw-r--r--"

  - name: "Results directory exists"
    path: "/RCode/league_results"
    shouldExist: true
    isDir: true

commandTests:
  - name: "Running as non-root user"
    command: "id"
    args: ["-u"]
    expectedOutput: ["1000"]
    excludedOutput: ["0"]
    
  - name: "User is appuser"
    command: "whoami"
    expectedOutput: ["appuser"]
    
  - name: "Working directory is /RCode"
    command: "pwd"
    expectedOutput: ["/RCode"]
    
  - name: "Can write to data directory"
    command: "touch"
    args: ["/ShinyApp/data/test_write"]
    exitCode: 0

  - name: "Can read from results directory"
    command: "test"
    args: ["-r", "/RCode/league_results"]
    exitCode: 0

  - name: "R version 4.3.1 installed"
    command: "R"
    args: ["--version"]
    expectedOutput: ["R version 4.3.1"]
  
  - name: "Shiny package available"
    command: "Rscript"
    args: ["-e", "library(shiny); cat('shiny loaded')"]
    expectedOutput: ["shiny loaded"]
    exitCode: 0
    
  - name: "Essential data manipulation packages"
    command: "Rscript"
    args: ["-e", "library(dplyr); library(ggplot2); cat('data packages loaded')"]
    expectedOutput: ["data packages loaded"]
    exitCode: 0
    
  - name: "Web packages for deployment"
    command: "Rscript"
    args: ["-e", "library(rsconnect); cat('rsconnect loaded')"]
    expectedOutput: ["rsconnect loaded"]
    exitCode: 0

  - name: "Shiny app syntax check"
    command: "Rscript"
    args: ["-e", "source('/ShinyApp/app.R', chdir=TRUE); cat('App syntax OK')"]
    expectedOutput: ["App syntax OK"]
    exitCode: 0

  - name: "Shiny update script is valid"
    command: "Rscript"
    args: ["-e", "if(file.exists('/RCode/updateShiny.R')) cat('UpdateShiny exists') else stop('Missing updateShiny')"]
    expectedOutput: ["UpdateShiny exists"]
    exitCode: 0