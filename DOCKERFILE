# This docker files needs to environment variables passed with -e at the run command:
# SHINYAPPS_IO_SECRET is the shinyapps secret
# RAPIDAPI_KEY is the RapidAPI key

# Start from a rocker r distribution distribution
FROM rocker/tidyverse:4.3.1

# Install necessary R packages
COPY packagelist.txt .
RUN while read in; do R -e "install.packages('$in')"; done < packagelist.txt

# Install cron
RUN apt-get update \
    && DEBIAN_FRONTEND=noninteractive apt-get -y --no-install-recommends install -y cron \
    # Remove package lists for smaller image sizes
    && rm -rf /var/lib/apt/lists/* \
    && which cron \
    && rm -rf /etc/cron.*/*

COPY entrypoint.sh /entrypoint.sh

# Set execute permission for entrypoint.sh
RUN chmod +x /entrypoint.sh

# Copy R scripts into the container
COPY RCode/ /RCode/

# Copy ShinyApp into the container
COPY ShinyApp/ /ShinyApp/

# Create data directory
RUN mkdir /ShinyApp/data

# Set Timezone
ENV TZ="Europe/Berlin"

# Set up a CRON job for every day at 14:45
RUN echo '45 14 * * * root R --save --restore -f /RCode/update_all_leagues_loop.R' > /etc/crontab

# Entrypoingt
ENTRYPOINT ["/entrypoint.sh"]

# The command that starts the cron service
CMD ["cron","-f", "-L", "2"]
